<?php
/**
 * @file
 * Contains all methods, related to in/uninstalling module and DB scheme.
 */

/**
 * Implements hook_field_schema().
 */
function ding_place2book_field_schema($field) {
  $schema = array();

  switch ($field['type']) {
    case 'ding_p2b':
      $schema['columns'] = array(
        'event_id' => array(
          'type' => 'varchar',
          'length' => 256,
          'not null' => FALSE,
          'default' => NULL,
        ),
        'event_maker_id' => array(
          'type' => 'varchar',
          'length' => 256,
          'not null' => FALSE,
          'default' => NULL,
        ),
        'synchronize' => array(
          'type' => 'int',
          'size' => 'tiny',
          'not null' => TRUE,
          'default' => 0,
        ),
      );
      break;
  }

  return $schema;
}

/**
 * Update ticket_type in all existing place2book-settings to 'Adgang'.
 */
function ding_place2book_update_7001() {
  $num_upd = db_update('ding_place2book')
    ->fields(array('ticket_type' => 'Adgang'))
    ->execute();
}

/**
 * Adds defaults for each existing event, deletes the old place2book field and
 * migrates old settings to new variables.
 */
function ding_place2book_update_7002(&$sandbox) {
  // Remove field.
  field_delete_field('field_place2book_tickets');

  // Get settings.
  $ding_place2book = variable_get('ding_place2book', array());
  $ding_place2book_event_nodes = variable_get('ding_place2book_event_nodes', array());

  variable_set('ding_p2b_default_kultunaut_export', (bool) $ding_place2book_event_nodes['defaults']['kultunaut_export']);
  variable_set('ding_p2b_default_passive', (bool) $ding_place2book_event_nodes['defaults']['passive']);
  variable_set('ding_p2b_default_synchronize', (bool) $ding_place2book_event_nodes['defaults']['maintain_copy']);
  variable_set('ding_p2b_default_capacity', $ding_place2book_event_nodes['capacity']);
  variable_set('ding_p2b_default_price_name', $ding_place2book_event_nodes['ticket_type']);

  // Migrate kultunaut category and target mappings.
  variable_set('ding_p2b_kultunaut_export_category', variable_get('ding_place2book_category_mappings'));
  variable_set('ding_p2b_kultunaut_age_group', variable_get('ding_place2book_target_mappings'));

  // Remove old variables.
  variable_del('ding_place2book');
  variable_del('ding_place2book_event_nodes');
  variable_del('ding_place2book_category_mappings');
  variable_del('ding_place2book_target_mappings');
  variable_del('ding_place2book_kultunaut_categories');
}

/**
 * Enable migration module for existing sites.
 */
function ding_place2book_update_7003() {
  module_enable(array('ding_place2book_migrate'));
}
